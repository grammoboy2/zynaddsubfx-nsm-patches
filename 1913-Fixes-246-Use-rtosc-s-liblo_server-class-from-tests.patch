From f4c3d7b42aef81fc3e092fc0e9b7e453fcd5e31d Mon Sep 17 00:00:00 2001
From: Johannes Lorenz <1042576+JohannesLorenz@users.noreply.github.com>
Date: Wed, 14 Jun 2023 22:53:05 +0200
Subject: [PATCH 1913/1936] Fixes #246: Use rtosc's liblo_server class from
 tests

---
 rtosc                     | 2 +-
 src/Tests/CMakeLists.txt  | 6 ++++--
 src/Tests/PortChecker.cpp | 5 ++++-
 3 files changed, 9 insertions(+), 4 deletions(-)

diff --git a/rtosc b/rtosc
index 17f5f8d0..aed6e417 160000
--- a/rtosc
+++ b/rtosc
@@ -1 +1 @@
-Subproject commit 17f5f8d021e54dbcaf99b854291bda49d8404930
+Subproject commit aed6e417cc868ce459edaae250b0e8ee9bbf20c2
diff --git a/src/Tests/CMakeLists.txt b/src/Tests/CMakeLists.txt
index f221ddc3..c5687bcd 100644
--- a/src/Tests/CMakeLists.txt
+++ b/src/Tests/CMakeLists.txt
@@ -7,7 +7,7 @@ function(quick_test test_name link)
     add_executable(${test_name} "${test_name}.cpp")
     add_test(NAME ${test_name}
              COMMAND ${test_name})
-     target_link_libraries(${test_name} ${link} ${ARGN})
+    target_link_libraries(${test_name} ${link} ${ARGN})
 endfunction()
 
 #for tests looking for files stored in the source dir
@@ -64,10 +64,12 @@ if(NOT (${CMAKE_SYSTEM_NAME} STREQUAL "Windows"))
     target_link_libraries(ins-test ${test_lib} rt)
 
     if(LIBLO_FOUND)
-        quick_test(PortChecker zynaddsubfx_core zynaddsubfx_nio
+        quick_test(PortChecker lo-server zynaddsubfx_core zynaddsubfx_nio
                    zynaddsubfx_gui_bridge
                    ${GUI_LIBRARIES} ${NIO_LIBRARIES} ${AUDIO_LIBRARIES}
                    ${PLATFORM_LIBRARIES})
+        target_include_directories(PortChecker PRIVATE ${RTOSC_TEST_INCLUDE_DIR})
+        target_link_directories(PortChecker PRIVATE ${RTOSC_TEST_LIB_DIR})
     endif()
     add_executable(save-osc SaveOSC.cpp)
     target_link_libraries(save-osc
diff --git a/src/Tests/PortChecker.cpp b/src/Tests/PortChecker.cpp
index 10458a2e..54c8ccf1 100644
--- a/src/Tests/PortChecker.cpp
+++ b/src/Tests/PortChecker.cpp
@@ -7,6 +7,7 @@
 #include <rtosc/thread-link.h>
 #include <rtosc/rtosc-time.h>
 #include <rtosc/port-checker.h>
+#include <liblo-server.h>  // from rtosc's test directory
 
 #include "../Misc/Master.h"
 #include "../Misc/MiddleWare.h"
@@ -88,7 +89,9 @@ class PortChecker
 
             bool ok;
             try {
-                rtosc::port_checker pc;
+                int timeout_msecs = 50;
+                rtosc::liblo_server sender(timeout_msecs), other(timeout_msecs);
+                rtosc::port_checker pc(&sender, &other);
                 ok = pc(mw->getServerPort());
 
                 if(!pc.print_sanity_checks())
-- 
2.47.0

