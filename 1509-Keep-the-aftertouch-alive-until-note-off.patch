From 5895c17f8579d3e3da4566e4e9bfc416e3ab52dc Mon Sep 17 00:00:00 2001
From: Hans Petter Selasky <hps@selasky.org>
Date: Sat, 4 Apr 2020 11:38:07 +0200
Subject: [PATCH 1509/1936] Keep the aftertouch alive until note off. Map zero
 velocity to one.

Signed-off-by: Hans Petter Selasky <hps@selasky.org>
---
 src/Misc/Part.cpp | 7 +++++++
 1 file changed, 7 insertions(+)

diff --git a/src/Misc/Part.cpp b/src/Misc/Part.cpp
index 5b2cd344..a0b5f5bf 100644
--- a/src/Misc/Part.cpp
+++ b/src/Misc/Part.cpp
@@ -609,6 +609,13 @@ void Part::PolyphonicAftertouch(note_t note,
     if(!Pnoteon || !inRange(note, Pminkey, Pmaxkey) || Pdrummode)
         return;
 
+    /*
+     * Don't allow the velocity to reach zero.
+     * Keep it alive until note off.
+     */
+    if(velocity == 0)
+        velocity = 1;
+
     // MonoMem stuff:
     if(!Ppolymode)   // if Poly is off
         monomem[note].velocity = velocity;       // Store this note's velocity.
-- 
2.47.0

