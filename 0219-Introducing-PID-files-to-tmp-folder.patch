From 5c53b256f1f9dcb7b74f6f090f354f356f36009c Mon Sep 17 00:00:00 2001
From: Johannes Lorenz <johannes89@mailueberfall.de>
Date: Sat, 9 Aug 2014 10:10:09 +0200
Subject: [PATCH 0219/1936] Introducing PID files to tmp folder.

---
 instruments             |  2 +-
 rtosc                   |  2 +-
 src/Misc/MiddleWare.cpp | 25 ++++++++++++++++++++++++-
 src/UI/NSM/Client.C     |  2 ++
 4 files changed, 28 insertions(+), 3 deletions(-)

diff --git a/instruments b/instruments
index f3657666..a06fadb9 160000
--- a/instruments
+++ b/instruments
@@ -1 +1 @@
-Subproject commit f365766661439d9aa63a203718410556c7307461
+Subproject commit a06fadb98d2d9937a2e0127f1a9f7e5f0237c29b
diff --git a/rtosc b/rtosc
index 58e39275..a63e2b97 160000
--- a/rtosc
+++ b/rtosc
@@ -1 +1 @@
-Subproject commit 58e392751494a848b2eca7abb82182fdd8a719ba
+Subproject commit a63e2b97b8276658f1709769592eb2896eabfe8b
diff --git a/src/Misc/MiddleWare.cpp b/src/Misc/MiddleWare.cpp
index bdf2a3ef..042188ff 100644
--- a/src/Misc/MiddleWare.cpp
+++ b/src/Misc/MiddleWare.cpp
@@ -306,13 +306,34 @@ class DummyDataObj:public rtosc::RtData
 static Fl_Osc_Interface *genOscInterface(struct MiddleWareImpl*);
 
 /* Implementation */
-struct MiddleWareImpl
+class MiddleWareImpl
 {
+    std::string get_tmp_file_name()
+    {
+         std::string tmp_file_name = "/tmp/zynaddsubfx_";
+         tmp_file_name += std::to_string(getpid());
+	 return tmp_file_name;
+    }
+public:
     MiddleWareImpl(void)
     {
         server = lo_server_new_with_proto(NULL, LO_UDP, liblo_error_cb);
         lo_server_add_method(server, NULL, NULL, handler_function, NULL);
         fprintf(stderr, "lo server running on %d\n", lo_server_get_port(server));
+        
+        {
+            std::string tmp_file_name = get_tmp_file_name();
+            if(0 == access(tmp_file_name.c_str(), F_OK)) {
+                fprintf(stderr, "Error: Cannot overwrite file %s. "
+                    "You should probably remove it.", tmp_file_name.c_str());
+                exit(EXIT_FAILURE);
+            }
+            FILE* tmp_fp = fopen(tmp_file_name.c_str(), "w");
+            if(!tmp_fp)
+                 fprintf(stderr, "Warning: could not create new file %s.\n", tmp_file_name.c_str());
+            fprintf(tmp_fp, "%d", (int)lo_server_get_port(server));
+            fclose(tmp_fp);
+        }
 
         //dummy callback for starters
         cb = [](void*, const char*){};
@@ -346,6 +367,8 @@ struct MiddleWareImpl
 
     ~MiddleWareImpl(void)
     {
+        remove(get_tmp_file_name().c_str());
+        
         warnMemoryLeaks();
 
         delete master;
diff --git a/src/UI/NSM/Client.C b/src/UI/NSM/Client.C
index 83141e27..18d55b5c 100644
--- a/src/UI/NSM/Client.C
+++ b/src/UI/NSM/Client.C
@@ -166,7 +166,9 @@ namespace NSM
     void
     Client::check(int timeout)
     {
+#ifdef LO_VERSION_GE_026
         if(lo_server_wait(_server, timeout))
+#endif
             while(lo_server_recv_noblock(_server, 0)) {}
     }
 
-- 
2.47.0

