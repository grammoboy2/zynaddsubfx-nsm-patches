From ea0771b33a746ef07782796460a2d48f00460b76 Mon Sep 17 00:00:00 2001
From: Daniel Sheeler <dsheeler@pobox.com>
Date: Tue, 5 Mar 2019 06:27:05 -0600
Subject: [PATCH 1317/1936] adparglobal volume to dB

---
 src/Misc/XMLwrapper.cpp         | 11 +++++++++++
 src/Misc/XMLwrapper.h           |  6 ++++++
 src/Params/ADnoteParameters.cpp | 15 +++++++--------
 src/Synth/ADnote.cpp            |  6 ++----
 src/Tests/guitar-adnote.xmz     |  4 ++--
 5 files changed, 28 insertions(+), 14 deletions(-)

diff --git a/src/Misc/XMLwrapper.cpp b/src/Misc/XMLwrapper.cpp
index c60c05a0..c3fd013a 100644
--- a/src/Misc/XMLwrapper.cpp
+++ b/src/Misc/XMLwrapper.cpp
@@ -565,6 +565,17 @@ string XMLwrapper::getparstr(const string &name,
     return defaultpar;
 }
 
+bool XMLwrapper::hasparreal(const char *name) const
+{
+    const mxml_node_t *tmp = mxmlFindElement(node,
+                                             node,
+                                             "par_real",
+                                             "name",
+                                             name,
+                                             MXML_DESCEND_FIRST);
+    return tmp != nullptr;
+}
+
 float XMLwrapper::getparreal(const char *name, float defaultpar) const
 {
     const mxml_node_t *tmp = mxmlFindElement(node,
diff --git a/src/Misc/XMLwrapper.h b/src/Misc/XMLwrapper.h
index 80b456c2..4c1822ed 100644
--- a/src/Misc/XMLwrapper.h
+++ b/src/Misc/XMLwrapper.h
@@ -201,6 +201,12 @@ class XMLwrapper
         std::string getparstr(const std::string &name,
                               const std::string &defaultpar) const;
 
+        /**
+         * Test existence of real parameter.
+         * @param name The parameter name.
+         */
+        bool hasparreal(const char *name) const;
+
         /**
          * Returns the real value stored in the node.
          * @param name The parameter name.
diff --git a/src/Params/ADnoteParameters.cpp b/src/Params/ADnoteParameters.cpp
index bd546ebb..d957e996 100644
--- a/src/Params/ADnoteParameters.cpp
+++ b/src/Params/ADnoteParameters.cpp
@@ -316,8 +316,8 @@ static const Ports globalPorts = {
     //Amplitude
     rParamZyn(PPanning, rShort("pan"), rDefault(64),
         "Panning of ADsynth (0 random, 1 left, 127 right)"),
-    rParamF(Volume,                   rShort("vol"), rLinear(0.0, 100.0),
-        rDefault(70.87), "volume control"),
+    rParamF(Volume,                   rShort("vol"), rLinear(-60.0f,20.0f),
+        rDefault(-3.75f), "volume control"),
     rParamZyn(PAmpVelocityScaleFunction, rShort("sense"), rDefault(64),
         "Volume velocity sense"),
     {"PVolume::i", rShort("vol.") rLinear(0,127)
@@ -326,10 +326,9 @@ static const Ports globalPorts = {
         {
             rObject *obj = (rObject *)d.obj;
             if (!rtosc_narguments(msg))
-                d.reply(d.loc, "i", (int)roundf(127.0f * obj->Volume
-                    / 100.0f));
+                d.reply(d.loc, "i", (int)roundf(96.0f * (1.0f + obj->Volume/60.0f)));
             else
-                obj->Volume = 100.0f * rtosc_argument(msg, 0).i / 127.0f;
+                obj->Volume = -60.0f * (1.0f - rtosc_argument(msg, 0).i / 96.0f);
         }},
     rParamZyn(Fadein_adjustment, rDefault(FADEIN_ADJUSTMENT_SCALE),
         "Adjustment for anti-pop strategy."),
@@ -472,7 +471,7 @@ void ADnoteGlobalParam::defaults()
     PBandwidth = 64;
 
     /* Amplitude Global Parameters */
-    Volume  = 70.87;
+    Volume  = -3.75f;
     PPanning = 64; //center
     PAmpVelocityScaleFunction = 64;
     AmpEnvelope->defaults();
@@ -927,11 +926,11 @@ void ADnoteGlobalParam::getfromXML(XMLwrapper& xml)
 
     if(xml.enterbranch("AMPLITUDE_PARAMETERS")) {
         const bool upgrade_3_0_3 = (xml.fileversion() < version_type(3,0,3)) ||
-            (xml.getparreal("volume", -1) < 0);
+            (!xml.hasparreal("volume"));
 
         if (upgrade_3_0_3) {
             int vol = xml.getpar127("volume", 0);
-            Volume    = 100.0f * vol / 127.0f;
+            Volume    = -60.0f * ( 1.0f - vol / 96.0f);
         } else {
             Volume    = xml.getparreal("volume", Volume);
         }
diff --git a/src/Synth/ADnote.cpp b/src/Synth/ADnote.cpp
index 5fc8f388..53c906a7 100644
--- a/src/Synth/ADnote.cpp
+++ b/src/Synth/ADnote.cpp
@@ -669,9 +669,7 @@ void ADnote::legatonote(LegatoParams lpars)
     int tmp[NUM_VOICES];
 
     NoteGlobalPar.Volume = 4.0f
-                           * powf(0.1f, 3.0f
-                                  * (1.0f - pars.GlobalPar.Volume
-                                     / 75.0f))                                      //-60 dB .. 0 dB
+                           * powf(10.0f, pars.GlobalPar.Volume / 20.0) //-60 dB .. 20 dB
                            * VelF(
         velocity,
         pars.GlobalPar.PAmpVelocityScaleFunction); //velocity sensing
@@ -1977,7 +1975,7 @@ void ADnote::Global::initparameters(const ADnoteGlobalParam &param,
     AmpLfo      = memory.alloc<LFO>(*param.AmpLfo, basefreq, time, wm,
                    (pre+"GlobalPar/AmpLfo/").c_str);
 
-    Volume = 4.0f * powf(0.1f, 3.0f * (1.0f - param.Volume / 75.0f)) //-60 dB .. 0 dB
+    Volume = 4.0f * powf(10.0f, param.Volume / 20.0) //-60 dB .. 20 dB
              * VelF(velocity, param.PAmpVelocityScaleFunction);     //sensing
 
     Filter = memory.alloc<ModFilter>(*param.GlobalFilter, synth, time, memory,
diff --git a/src/Tests/guitar-adnote.xmz b/src/Tests/guitar-adnote.xmz
index 16c335f2..138ad4e5 100644
--- a/src/Tests/guitar-adnote.xmz
+++ b/src/Tests/guitar-adnote.xmz
@@ -66,7 +66,7 @@ version-revision="3" ZynAddSubFX-author="Nasca Octavian Paul">
 <ADD_SYNTH_PARAMETERS>
 <par_bool name="stereo" value="yes" />
 <AMPLITUDE_PARAMETERS>
-<par name="volume" value="73" />
+<par_real name="volume" value="-14.375" exact_value="0xC165FFFF" />
 <par name="panning" value="74" />
 <par name="velocity_sensing" value="85" />
 <par name="fadein_adjustment" value="20" />
@@ -764,7 +764,7 @@ version-revision="3" ZynAddSubFX-author="Nasca Octavian Paul">
 <INSTRUMENT_EFFECT id="0">
 <EFFECT>
 <par name="type" value="6" />
-<par name="preset" value="4" />
+<par name="preset" value="0" />
 <EFFECT_PARAMETERS>
 <par_no id="0">
 <par name="par" value="112" />
-- 
2.47.0

