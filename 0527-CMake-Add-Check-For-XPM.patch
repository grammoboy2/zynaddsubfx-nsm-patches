From 6de7be1e8cce0c1a599e95e0a95370602478dc07 Mon Sep 17 00:00:00 2001
From: fundamental <mark.d.mccurry@gmail.com>
Date: Mon, 3 Aug 2015 15:39:42 -0400
Subject: [PATCH 0527/1936] CMake: Add Check For XPM

Fixes Bug #74
---
 src/CMakeLists.txt    |  6 ++++--
 src/UI/CMakeLists.txt | 10 ++++++++--
 src/UI/MasterUI.fl    |  6 +++---
 3 files changed, 15 insertions(+), 7 deletions(-)

diff --git a/src/CMakeLists.txt b/src/CMakeLists.txt
index 9e5f5477..4dadd025 100644
--- a/src/CMakeLists.txt
+++ b/src/CMakeLists.txt
@@ -4,9 +4,11 @@ message(STATUS "Checking Library Path" $ENV{CMAKE_LIBRARY_PATH} ${CMAKE_LIBRARY_
 
 #Dependency check
 include(CheckFunctionExists)
+include(CheckIncludeFile)
 find_package(PkgConfig REQUIRED)
 find_package(zlib REQUIRED)
 find_package(X11)
+check_include_file(X11/xpm.h HAS_XPM)
 pkg_check_modules(FFTW REQUIRED fftw3)
 pkg_check_modules(MXML REQUIRED mxml)
 find_package(Threads   REQUIRED)
@@ -267,7 +269,7 @@ if(FltkGui)
 
 
 	set(GUI_LIBRARIES zynaddsubfx_gui ${FLTK_LIBRARIES} ${FLTK_LIBRARIES} ${OPENGL_LIBRARIES})
-    if(X11_FOUND)
+    if(X11_FOUND AND HAS_XPM)
         set(GUI_LIBRARIES ${GUI_LIBRARIES} ${X11_LIBRARIES} -lXpm)
     endif()
 
@@ -291,7 +293,7 @@ if(NtkGui)
 
 	set(GUI_LIBRARIES zynaddsubfx_gui ${NTK_LIBRARIES} ${NTK_IMAGES_LIBRARIES} ${OPENGL_LIBRARIES})
 
-    if(X11_FOUND)
+    if(X11_FOUND AND HAS_XPM)
         set(GUI_LIBRARIES ${GUI_LIBRARIES} ${X11_LIBRARIES} -lXpm)
     endif()
 
diff --git a/src/UI/CMakeLists.txt b/src/UI/CMakeLists.txt
index de0df382..7b0d85b7 100644
--- a/src/UI/CMakeLists.txt
+++ b/src/UI/CMakeLists.txt
@@ -34,16 +34,22 @@ if(FltkGui)
     add_executable(zynaddsubfx-ext-gui guimain.cpp)
     target_link_libraries(zynaddsubfx-ext-gui zynaddsubfx_gui ${FLTK_LIBRARIES}
         ${FLTK_LIBRARIES} ${OPENGL_LIBRARIES} ${LIBLO_LIBRARIES} rtosc rtosc-cpp)
-    if(X11_FOUND)
+    if(X11_FOUND AND HAS_XPM)
+        add_definitions(-DHAS_X11=1)
         target_link_libraries(zynaddsubfx-ext-gui ${X11_LIBRARIES} -lXpm)
+    else()
+        add_definitions(-DHAS_X11=0)
     endif()
     install(TARGETS zynaddsubfx-ext-gui RUNTIME DESTINATION bin)
 elseif(NtkGui)
     add_executable(zynaddsubfx-ext-gui guimain.cpp)
     target_link_libraries(zynaddsubfx-ext-gui zynaddsubfx_gui ${NTK_LDFLAGS}
         ${OPENGL_LIBRARIES} ${LIBLO_LIBRARIES} rtosc rtosc-cpp)
-    if(X11_FOUND)
+    if(X11_FOUND AND HAS_XPM)
+        add_definitions(-DHAS_X11=1)
         target_link_libraries(zynaddsubfx-ext-gui ${X11_LIBRARIES} -lXpm)
+    else()
+        add_definitions(-DHAS_X11=0)
     endif()
     install(TARGETS zynaddsubfx-ext-gui RUNTIME DESTINATION bin)
 endif()
diff --git a/src/UI/MasterUI.fl b/src/UI/MasterUI.fl
index 2fee90ac..80e2dd9b 100644
--- a/src/UI/MasterUI.fl
+++ b/src/UI/MasterUI.fl
@@ -17,7 +17,7 @@ decl {\#include <stdio.h>} {public local
 decl {\#include <string.h>} {public local
 } 
 
-decl {\#if defined(__linux__) && ! defined(PLUGINVERSION)
+decl {\#if ! defined(PLUGINVERSION) && HAS_X11
 \#include "zynaddsubfx.xpm"
 \#endif} {public local
 } 
@@ -76,7 +76,7 @@ extern NSM_Client *nsm;
 \#endif} {public local
 } 
 
-decl {\#if defined(__linux__) && ! defined(PLUGINVERSION)
+decl {\#if !defined(PLUGINVERSION) && HAS_X11
 \#include <X11/xpm.h>
 \#endif} {public local
 } 
@@ -1502,7 +1502,7 @@ configui=new ConfigUI(osc);
 make_window();
 fl_open_display();
 
-\#if defined(__linux__) && ! defined(PLUGINVERSION)
+\#if !defined(PLUGINVERSION) && HAS_X11
 Pixmap p, mask;
 XCreatePixmapFromData(fl_display, DefaultRootWindow(fl_display),
                                  (char**)zynaddsubfx_xpm, &p, &mask, NULL);
-- 
2.47.0

