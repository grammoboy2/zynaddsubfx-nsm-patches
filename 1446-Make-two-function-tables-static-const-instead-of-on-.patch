From e3bc943f04e4ecf044857f33bc8407cad18ef05b Mon Sep 17 00:00:00 2001
From: Hans Petter Selasky <hps@selasky.org>
Date: Fri, 8 Nov 2019 11:13:20 +0100
Subject: [PATCH 1446/1936] Make two function tables static const instead of on
 the stack. Remove repeated typedefs. No functional change.

Signed-off-by: Hans Petter Selasky <hps@selasky.org>
---
 rtosc                  |  2 +-
 src/Synth/OscilGen.cpp | 43 +++++++++++++++++++++---------------------
 src/Synth/OscilGen.h   |  8 ++++----
 3 files changed, 26 insertions(+), 27 deletions(-)

diff --git a/rtosc b/rtosc
index d54496f1..eed63261 160000
--- a/rtosc
+++ b/rtosc
@@ -1 +1 @@
-Subproject commit d54496f13c08ee511995516bdd10ce85da453f1a
+Subproject commit eed63261d3bbf2ff16e3336842eee01da4d41c3c
diff --git a/src/Synth/OscilGen.cpp b/src/Synth/OscilGen.cpp
index 985056b6..3cb8d345 100644
--- a/src/Synth/OscilGen.cpp
+++ b/src/Synth/OscilGen.cpp
@@ -524,7 +524,7 @@ void OscilGen::getbasefunction(float *smps)
             break;
     }
 
-    base_func func = getBaseFunction(Pcurrentbasefunc);
+    base_func_t *func = getBaseFunction(Pcurrentbasefunc);
 
     for(int i = 0; i < synth.oscilsize; ++i) {
         float t = i * 1.0f / synth.oscilsize;
@@ -566,7 +566,7 @@ void OscilGen::oscilfilter(fft_t *freqs)
 
     const float par    = 1.0f - Pfilterpar1 / 128.0f;
     const float par2   = Pfilterpar2 / 127.0f;
-    filter_func filter = getFilter(Pfiltertype);
+    filter_func_t *filter = getFilter(Pfiltertype);
 
     for(int i = 1; i < synth.oscilsize / 2; ++i)
         freqs[i] *= filter(i, par, par2);
@@ -1630,19 +1630,9 @@ FUNC(circle)
     return y;
 }
 
-typedef float (*base_func)(float, float);
-
-base_func getBaseFunction(unsigned char func)
+base_func_t *getBaseFunction(unsigned char func)
 {
-    if(!func)
-        return NULL;
-
-    if(func == 127) //should be the custom wave
-        return NULL;
-
-    func--;
-    assert(func < 15);
-    base_func functions[] = {
+    static const base_func_t *functions[] = {
         basefunc_triangle,
         basefunc_pulse,
         basefunc_saw,
@@ -1659,6 +1649,15 @@ base_func getBaseFunction(unsigned char func)
         basefunc_spike,
         basefunc_circle,
     };
+
+    if(!func)
+        return NULL;
+
+    if(func == 127) //should be the custom wave
+        return NULL;
+
+    func--;
+    assert(func < (sizeof(functions)/sizeof(functions[0])));
     return functions[func];
 }
 
@@ -1791,15 +1790,9 @@ FILTER(s)
 }
 #undef FILTER
 
-typedef float (*filter_func)(unsigned int, float, float);
-filter_func getFilter(unsigned char func)
+filter_func_t *getFilter(unsigned char func)
 {
-    if(!func)
-        return NULL;
-
-    func--;
-    assert(func < 13);
-    filter_func functions[] = {
+    static const filter_func_t *functions[] = {
         osc_lp,
         osc_hp1,
         osc_hp1b,
@@ -1814,6 +1807,12 @@ filter_func getFilter(unsigned char func)
         osc_low_shelf,
         osc_s
     };
+
+    if(!func)
+        return NULL;
+
+    func--;
+    assert(func < (sizeof(functions)/sizeof(functions[0])));
     return functions[func];
 }
 
diff --git a/src/Synth/OscilGen.h b/src/Synth/OscilGen.h
index 8ca6ae64..6a247035 100644
--- a/src/Synth/OscilGen.h
+++ b/src/Synth/OscilGen.h
@@ -180,10 +180,10 @@ class OscilGen:public Presets
         const SYNTH_T &synth;
 };
 
-typedef float (*filter_func)(unsigned int, float, float);
-filter_func getFilter(unsigned char func);
-typedef float (*base_func)(float, float);
-base_func getBaseFunction(unsigned char func);
+typedef float filter_func_t(unsigned int, float, float);
+filter_func_t *getFilter(unsigned char func);
+typedef float base_func_t(float, float);
+base_func_t *getBaseFunction(unsigned char func);
 
 }
 
-- 
2.47.0

